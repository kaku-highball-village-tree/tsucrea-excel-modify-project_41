# 率行（計画列）が左寄せになる原因調査（比較付き）

## 1. 結論（事実）
- 原因は **「率（%）を文字列としてExcelに書き込んでいるため」** です。
- 計画列の「売上総利益率」「営業利益率」は、累計時に `"{0:.2f}%"` で生成されています。
- TSV→Excel 変換の数値判定は整数/小数のみで、`%` 付き値は数値化されません。
- そのため Excel では文字列扱いになり、左寄せ表示になります。

## 2. なぜこの仕様になった可能性が高いか（コードから読み取れる意図）
実装コメントはありませんが、コードの流れから次の意図が推定できます。

- 単月では「計画.csvの値をそのまま採用」している（`objRow[2] = objValues[0]`）。
- `計画.csv` 側が `%` 付き表記（例: `23.70%`）を持ちうる前提で、数値パース側も `%` を許容しています。
- そのため累計時も見た目を合わせるため `%` 付き文字列で出力した、という整合性重視の実装になっている可能性が高いです。

> つまり「Excel内部での数値型」よりも「TSV/CSV上の表示表記（%付き）」を優先した実装と読めます。

## 3. 他の箇所との比較（列挙）

### A. 今回問題の箇所（計画列の率）
- 累計時の率を `"xx.xx%"` の**文字列**で生成している。
- その値は TSV→Excel で数値化されず、文字列のままセルに入る。

### B. 同じ画面内の別列（前年比）
- 前年比は `"{0:.4f}"` で **数値文字列（%なし）** を生成している。
- TSV→Excel 変換で `float` に変換されるため、Excelでは数値として扱われる。
- 例外値のみ `＋∞/－∞` の文字列。

### C. PJサマリ等の他テンプレート出力
- 多くの出力で TSV→Excel 変換時に `parse_tsv_value_for_excel` を通しており、
  - 整数/小数は数値化
  - `＋∞/－∞` は文字列
  - `%` 付き値は文字列
  というルールで統一されています。
- つまり「`＋∞/－∞` 以外は常に数値」ではなく、実際は「`%` 付きも文字列扱い」です。

## 4. 仕様の選択肢（ここから選べるように提案）
以下は **実装案ではなく仕様案** です。どれを採用するか選んでいただければ、その方針で次回実装可能です。

1. **現状維持（表示優先）**
   - 率は `23.70%` の文字列として保持。
   - 利点: TSV/CSV上の見た目が分かりやすい、単月/累計の見た目整合が取りやすい。
   - 欠点: Excel上は文字列扱いになり、左寄せ・数式利用がしにくい。

2. **数値統一（他列と同じ“値型優先”）**
   - 率は `0.237` の数値で保持し、表示はセル書式 `%` で見せる。
   - 利点: Excel上で右寄せ/集計/計算が自然。
   - 欠点: TSV単体で見たとき直感的でない（`0.237`）。テンプレート書式依存が増える。

3. **ハイブリッド**
   - TSVには数値（0.237）、別列や注記で表示用 `%` を持つ。
   - 利点: 機械処理と可読性の両立。
   - 欠点: 列設計が複雑になりやすい。

## 5. 推奨（提案）
- ご認識どおり「`＋∞/－∞` 以外は数値に寄せたい」方針なら、
  **選択肢2（数値統一）** が最も一貫性があります。
- ただし、運用でTSVを直接目視する頻度が高い場合は **選択肢1** の利便性もあります。

---

## 参照コード（根拠）
- 計画率の `%` 文字列生成（累計）: `apply_cp_company_plan_values`。
- 単月で計画値をそのまま採用: `objRow[2] = objValues[0]`。
- `%` を含む文字列を plan 数値パースでは許容: `parse_plan_numeric_value`。
- 前年比は `%` なし数値文字列で生成: `objRow[4] = "{0:.4f}"...`。
- TSV→Excel 変換は整数/小数のみ数値化、`%` は文字列のまま: `parse_tsv_value_for_excel`。
- Excel書き込みは変換結果をそのまま `cell(value=...)` に設定。

※本調査では実装変更は行っていません。
